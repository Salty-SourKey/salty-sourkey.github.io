---
layout: post
title: All About 1/3 at BFT Consensus
author: Sejin Hwang
tags: [consensus]
use_math: true
---

**TL;DR:** 전체 노드 중 비잔틴 노드의 비율이 1/3 미만임을 가정하는 것은 일반적인 BFT 합의 알고리즘이 Safety와 Liveness를 동시에 보장하기 위해 필요한 가정이다. 이러한 가정 아래서 전체 노드 중 일부 합의체를 선출하여 합의를 진행하는 방식은 BFT 합의 알고리즘의 처리량을 높일 수 있지만 보안적인 문제를 야기한다. 합의체의 안전한 합의를 보장하는 방법으로는 단발적인 Global Communication을 수행하는 방식과 Global Communication 없이 합의 정족수를 상향하는 것이 있다.

<br>

# BFT 합의 알고리즘이 보장해야 하는 성질
- Safety
    - 모든 합의는 올바르게 되어야 함
    - 합의 알고리즘에 참여하는 모든 노드가 동일한 대상에 합의한다는 것을 보장한다면 Safety를 만족한다고 할 수 있음
- Liveness
    - 계속해서 멈추지 않고 합의를 해야 함
    - 합의 알고리즘에 참여하는 노드에서 장애가 발생하여도 합의가 계속됨을 보장한다면 Liveness를 만족한다고 할 수 있음

## Safety 보장 조건: Quorum Intersection
<subfigure>
  <img src="./images/2025-06-13/intersection.png" width="50%">
</subfigure>

**Quorum Intersection이란?**

전체 노드 개수가 $n$이고, 그중 $f$개의 비잔틴 노드가 있을 때, 정족수 $q$의 크기를 가지는 서로 다른 노드 집합 $Q_1$ 그리고 $Q_2$는 최소 1개의 공통되는 정상 노드를 가져야 함

위 성질이 보장된다면, 서로 다른 두 블록이 정족수 이상의 투표를 동시에 모았을 때, 두 정족수 집합은 공통되는 정상 노드의 투표를 최소 1개를 가지게 된다. 하지만 정상 노드는 서로 다른 두 개의 대상에 동시에 투표하는 행동을 하지 않기에 모순이 발생한다. 즉, 서로 다른 두 블록이 동시에 정족수 이상의 투표를 모으는 것은 불가능하다는 것이다. 따라서 정직한 노드가 서로 다른 대상에 합의하는 상황은 발생하지 않아 Safety가 보장된다.

이에 따라, 정족수는 $q+q-n-f>0$, 즉, $\frac {n+f} {2} < q$를 만족해야 한다.

## Liveness 보장 조건: Quorum Formation
**Quorum Formation이란?**

전체 노드 개수가 $n$이고, 그중 $f$개의 비잔틴 노드가 있을 때, 정족수 $q$는 정상 노드 개수의 최댓값보다 작아야 함

위 성질이 보장된다면, 모든 비잔틴 노드에서 장애가 발생하더라도 나머지 정상 노드들이 정족수 이상의 투표를 모을 수 있기에, BFT 합의 알고리즘에서 블록을 제안하는 리더가 비잔틴 노드가 아니라면 Liveness가 보장된다.

이에 따라, 정족수는 $q \ge n-f$를 만족해야 한다.

<br>

# Why n ≥ 3f+1?
Safety 보장 조건인 Quorum Intersection을 만족하기 위한 $\frac {n+f} {2} < q$과 Liveness 보장 조건 중 하나인 Quorum Formation을 만족하기 위한 $q \ge n-f$의 부등식을 풀면 다음과 같은 식이 나온다.

<center>$\frac{n+f}{2} < q \le n-f$</center>

<center>$n+f < 2n-2f$</center>

<center>$3f < n$</center>

<center>$3f + 1 \le n$</center>

즉, 전체 노드 중 비잔틴 노드의 비율이 1/3 미만임을 가정하고 정족수로 전체 노드 개수의 2/3를 사용하는 것은 일반적인 BFT 합의 알고리즘이 Safety와 Liveness를 동시에 보장하기 위해 필요한 가정이라는 것을 확인할 수 있다.

<br>

# What if n/3 ≤ f?

## Breaking Liveness when n/3 ≤ f
<subfigure>
  <img src="./images/2025-06-13/breaklive.png" width="70%">
</subfigure>

전체 노드 수가 8개일 때, 일반적인 BFT 합의 알고리즘은 최대 2개의 비잔틴 노드까지 견딜 수 있다. 최악의 경우에도 Safety와 Liveness를 동시에 보장하는 정족수는 6이기 때문이다.

<center>$\frac{n+f}{2} < q \le n-f$</center>

<center>$5 < q \le 6$</center>

하지만 $f < n/3$ 가정을 넘어서는 3개의 비잔틴 노드가 존재하고 이들이 의도적으로 메시지를 전파하지 않는 Silence Attack을 수행할 시, 합의 진행을 위해 필요한 정족수인 6개 이상의 투표가 모일 수 없어 Liveness가 깨진다.

## Breaking Safety when n/3 ≤ f
<subfigure>
  <img src="./images/2025-06-13/breaksafe.png" width="100%">
</subfigure>

전체 노드 수가 10개일 때, 일반적인 BFT 합의 알고리즘은 최대 3개의 비잔틴 노드까지 견딜 수 있다. 하지만 이를 넘어서는 4개의 비잔틴 노드(n1, n2, n3, n4)가 존재하고 그중 하나가 블록을 제안하는 리더라면 정직한 노드들이 서로 다른 블록을 수락하게 만드는 Forking Attack을 가할 수 있다.

리더인 n1이 서로 다른 두 개의 블록 a 그리고 b를 두 개의 정직한 노드 집합에 각각 전파하고 모든 비잔틴 노드들이 해당하는 두 블록 모두에 동시에 투표를 한다면, 블록 a 그리고 b는 동시에 정족수를 만족할 수 있다. 이를 통해 정직한 노드들이 서로 다른 블록을 수락하게 만드는 Forking Attack을 성공시킬 수 있다.

<br>

# Why should we care about this?
사실 현재 운용 중인 대부분의 공개 블록체인에서 비잔틴 활동은 거의 발견되지 않는다고 함
- 이더리움에서 대부분의 슬래싱 원인은 악의적인 행동이 아닌 실수 또는 의도치 않은 에러라고 함
- “Byzantine failures are rare as validators are highly protected, isolated, and economically incentivized to follow the protocol, more common are validators that are unresponsive.” by Spiegelman et at. 2024

그럼에도 불구하고 임의의 집단의 1/3 이상이 비잔틴으로 오염되는 상황은 고려해야 할 필요가 있는 문제임
- 일반적인 BFT 합의 알고리즘은 모든 노드가 합의에 참여하는 것을 가정하지만, 이는 블록체인 성능에 확장성 제약을 야기함
- 따라서 확장성을 높이기 위해 전체 노드 집합에서 뽑은 작은 크기의 합의체가 합의를 진행하는 방법이 고려될 수 있음
- 하지만 $f < \frac n 3$ 가정에서 합의체를 선출할 때, 선출된 합의체의 1/3 이상이 비잔틴 노드일 확률이 존재하여 BFT 합의의 성질인 Safety 또는 Liveness가 깨질 수 있음
    - 전체 노드 수가 100개 그리고 비잔틴 노드 수가 33개인 상황에서 10개의 노드로 구성된 합의체를 뽑을 때, 해당 합의체의 1/3 이상이 비잔틴일 확률은 $\sum_{b=4}^{10} \frac{\binom{67}{10-b} \binom{33}{b}}{\binom{100}{10}} \approx 43\%$

<br>

# 선출된 작은 합의체에서의 BFT 합의 방법
전체 노드 집합에서 작은 크기의 합의체를 선출하여 BFT 합의를 진행하는 방식은 확장성이 높지만 보안적 문제가 발생할 수 있다. 이를 해결할 수 있는 방법은 크게 두 가지가 있다.
- Global Communication을 통해 $f < n/3$을 가정한 전체 네트워크 단위의 정족수를 모아 안전한 결정을 내리는 방식
- Global Communication 없이 합의체의 정족수를 상향하는 방식 

## Proteus: A Scalable BFT Consensus Protocol for Blockchains
작은 크기의 합의체에서 BFT 합의를 수행하되, 단발적인 Global Communication을 통해 전체 네트워크 단위의 정족수를 모아 합의체가 합의한 결정이 안전한 결정인지 검증하는 방식
<subfigure>
  <img src="./images/2025-06-13/proteus.png" width="100%">
</subfigure>
- $f < n/3$일 때, 전체 노드 집합에서 $c$개의 노드를 뽑아 구성한 합의체가 PBFT를 수행
- 전체 노드는 합의체가 수행한 PBFT에서 Commit 단계를 통과한 블록을 검증
- $2n/3$개 이상의 노드가 블록 검증을 완료했다면 해당 블록은 확정됨
- 통신 복잡도가 $O(c^2+cn)$으로 줄고 합의체 크기 $c$는 전체 노드 수 $n$에 비례하지 않기에 확장성 있음

### Proteus의 합의체 크기 설정 방식
Proteus는 $c$개의 노드로 구성된 합의체의 2/3 미만이 비잔틴 노드임을 보장하여, 비잔틴 노드만으로 정족수 집합을 형성할 수 없도록 한다면 안전하게 블록 합의를 진행할 수 있다고 서술한다. 이를 위해 Proteus는 어떠한 경우에도 합의체의 최대 비잔틴 비율이 2/3 미만이라는 것을 확률적으로 보장하는 c를 설정한다. Proteus의 합의체 크기 설정 방식은 다음과 같다.
1. 합의체 오염 발생 확률의 상한 $\epsilon$을 결정
2. 임의로 선택된 노드가 비잔틴일 확률을 1/3 그리고 합의체 속 비잔틴 노드 수를 확률 변수 C로 설정
3. $P(C < 2c/3) < 1 - \epsilon$을 만족하는 합의체 크기 c를 계산

예를 들어, 전체 노드 수가 100개 그리고 비잔틴 노드 수가 33개인 상황에서, $c=30$인 합의체의 2/3 미만이 비잔틴 노드일 확률은 $1-\sum_{b=21}^{30} \frac{\binom{67}{10-b} \binom{33}{b}}{\binom{100}{10}} \approx 0.9999994$이다. 합의체 오염 발생 확률의 상한을 $\epsilon=10^{-6}$로 설정했다면, 크기 $c=30$의 합의체는 어떠한 경우에도 비잔틴 비율이 2/3을 넘지 않는다는 것이 확률적으로 보장된다고 여긴다.

### Proteus의 합의체 오염(비잔틴 비율이 1/3 이상) 해결 방식
- Breaking Liveness
    - 정상 노드에서 Timeout이 발생되어 합의체 변경을 시도하는 View-Change가 시작됨
    - 충분한 수의 노드(2f+1)에서 Timeout이 발생될 것이기에 View-Change는 문제 없이 수행될 수 있음 
- Forking Attack
    - 합의체에 포함되어 있는 정상 노드가 합의된 블록을 모든 노드에게 전파하기에 다른 노드들이 Fork를 확인할 수 있음
    - 이를 확인한 정상 노드는 합의체 변경을 시도하는 View-Change를 시작함
    - 충분한 수의 노드(2f+1)가 Fork를 확인할 것이기에 View-Change는 문제 없이 수행될 수 있음

### Proteus의 View-Change
<subfigure>
  <img src="./images/2025-06-13/protview.png" width="80%">
</subfigure>
PBFT와는 다르게, Proteus에서의 View-Change는 기존 합의체를 새로운 합의체로 교체하는 것을 의미한다. View-Change 시, 임의의 랜덤하고 결정론적인 방식으로 모두가 동일한 합의체를 새로 뽑고, 자신의 로컬 합의 상태를 새 합의체에게 전달하여 마지막으로 합의된 블록부터 새로 합의를 시작하게 된다.

### Proteus v.s. PBFT
<subfigure>
  <img src="./images/2025-06-13/proteval.png" width="90%">
</subfigure>
위 실험 결과에 따르면, Proteus가 PBFT의 지연 시간을 개선하였다는 것을 확인할 수 있다. 이는 통신 복잡도가 감소하는 것에 기인하는 것으로 보인다. 하지만 Proteus는 전체 네트워크 크기가 확장됨에 따라 처리량이 크게 감소하며, 그 감소 추세는 PBFT와 비슷한 양상을 보인다. 이는 Proteus의 합의 단계에서 여전히 존재하는 Global Communication이 처리량의 확장성을 제약하는 것으로 추측된다.

## 정족수 임계치 상향의 방식
전체 네트워크의 비잔틴 비율이 1/3 미만이라는 가정 아래서, 합의 참여자의 2/3를 정족수로 사용하는 것은 물리적인 한계가 아닌, 단순히 Safety와 Liveness를 동시에 보장하기 위한 평형 조건이다. 따라서, 이 제약 조건을 완화하여 정족수 크기를 조정 가능한 파라미터로 여긴다면, 시스템은 Liveness를 희생하는 대신 Safety를 향상시킬 수 있다.

위에 서술했듯, 전체 노드 개수가 $n$이고 그중 최대 $f$개의 비잔틴 노드가 존재할 때, Quorum Intersection 성질을 만족시켜 Safety를 보장하는 정족수 임계치 $q$의 조건은 $\frac {n+f} {2} < q$이다. 즉, Safety만을 보장하는 최소 정족수 임계치는 다음과 같다.
<center>$q=\lceil\frac{(n+f+1)} {2}\rceil$</center>

즉, 크기 $c$를 가지는 합의체 선출 시, 해당 합의체 속 비잔틴 노드의 수가 $f_C$ 미만이라면 정족수 $q=\lceil\frac{(c+f_C+1)} {2}\rceil$를 사용하는 것으로 합의체 합의 과정의 Safety를 보장할 수 있다. 예를 들어, $c=10$이고 $f_C=5$라면 $q=8$이 산출되며, 이는 일반적으로 사용되는 정족수인 7보다 상향된 정족수이며, 합의체가 1/3보다 더 높은 비잔틴 비율을 가짐에도 불구하고 Safety를 보장할 수 있다. 


이러한 정족수 임계치 상향은 합의체의 Safety를 보장할 수 있지만 Liveness를 희생한다. 합의체 속 두 비잔틴 노드가 Silence Attack을 수행한다면 합의는 더 이상 진행될 수 없기 때문이다. 하지만 감지하기 어려우며 블록체인 상태의 무결성을 깰 수 있는 심각한 문제인 Safety 위반과는 달리, Liveness가 깨지는 상황은 단지 합의가 지연되는 것이고 전체 네트워크가 Timeout 메커니즘을 통해 감지 및 복구 가능하다. 따라서, 정족수 임계치를 상향하는 방식을 통해 합의체에서 진행되는 합의의 Safety를 보장할 수 있다면, Proteus와 같이 매 합의 마다 Global Communication을 요구하는 것이 아닌, Liveness에 문제가 발생할 때만 요구하기에 더욱 확장성이 있다고 할 수 있다. 

하지만 실제 블록체인 네트워크에서 비잔틴 노드의 수가 특정 임계치를 넘지 않는다는 것은 결정론적으로 보장하는 것은 불가능하며, 이는 확률적으로 접근할 수밖에 없다. 즉, 선출된 합의체 속 비잔틴 노드 개수의 상한 $f_C$ 또한 확률적으로 계산할 수 밖에 없다. 이를 계산하는 방법 중 하나는 전체 네트워크의 보안성이 유지될 확률을 산출하고, 합의체의 보안성이 유지될 확률을 산출된 값과 동일한 수준이 될 수 있도록 하는 정족수 임계치를 계산하는 방식이다. 어차피 전체 네트워크의 보안성이 깨진다면 합의체 보안성은 아무 의미 없으며, 전체 네트워크가 안전하다면 합의체 또한 안전하다고 할 수 있기 때문이다.

노드가 비잔틴 행동을 수행할 확률을 $p$ 그리고 전체 비잔틴 노드 개수를 확률 변수 $X$라고 둘 때, Safety 보장 조건인 $X \le f$는 $P(X \le f)$의 확률로 성립하는 것이다. 예를 들어, 전체 노드 개수가 $n=1000$이고 각 노드가 비잔틴일 확률이 $p=0.1$이라면, 전체 비잔틴 노드 개수 $X$는 $\mu=100$ 그리고 $\sigma=9.49$의 정규 분포로 근사된다. 이러한 정규 분포 아래서 시스템이 $q=667$($f=333$에 따라 계산되는 정족수)를 사용한다면 Safety 위반 발생의 확률은 무시할 수 있을 정도로 낮다.
<center>$P(X\le333) \approx 1-2.05 \times 10^{-133}$</center>

이러한 확률적 보안성을 가지는 전체 네트워크에서 $c=100$의 합의체를 선출할 때, 해당 합의체 속 비잔틴 노드 개수를 확률 변수 $Y$라고 둔다면, 이는 $\mu=10$ 그리고 $\sigma=3$의 정규 분포로 근사된다. 이때, 합의체가 전체 네트워크와 동일한 Safety 위반 확률 $2.05 \times 10^{-133}$을 유지하기 위해서, 합의체가 감내할 수 있는 비잔틴 노드 개수는 $f_C=84$로 계산된다. 이렇게 계산된 $f_C$를 정족수 임계치 계산식에 넣는다면 $q=93$이 산출된다. 즉, 100개의 노드로 선출한 합의체에서 정족수 $q=93$을 사용한다면 전체 네트워크와 동일한 확률로 Safety가 보장된다는 것이다.

물론 정족수 임계치를 상향하는 것은 각 노드가 더 많은 투표를 모아야 한다는 것을 의미하기에 시스템의 처리량을 저해할 수 있다. 이에 따라 시스템 설계자는 자신이 설정할 시스템의 보안성 파라미터를 낮게(e.g., $10^{-6}$ 또는 $10^{-9}$) 설정하는 것으로 정족수 임계치를 낮추고 높은 처리량을 얻을 것인지, 또는 처리량을 희생하고 보안성을 더욱 확보할 것인지 선택할 수 있다. 즉, 이러한 확률적 정족수 향상 방식은 비잔틴 합의를 고정된 임계값 제약으로 간주하는 것이 아닌, Safety 보장과 효율성 간의 균형을 맞추는 최적화 문제로 재정의한다.